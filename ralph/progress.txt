# Ralph Progress Log
# Branch: ralph/backend-query-optimization
# Started: 2026-01-13

## Codebase Patterns
- CountryJdbcRepository already has `findAllByIdIn(Set<Long> ids)` method with @Query annotation for batch loading
- InMemoryCountryRepository uses `java.util.*` wildcard import covering all collection types
- Port interfaces are in `application/port/`, JDBC adapters in `adapter/driven/jdbc/`, inmemory in `adapter/driven/inmemory/`
- Organisation domain stores CountryId (not Country), so asOrganisation() doesn't need to resolve Countries - just extract IDs
- OrganisationDbo.asOrganisation() accepts either resolver functions OR maps - use maps for batch loading
- EventOrganisationDbo.id is package-private, access with `eo.id.getId()` not via getter
- JdbcRepository.findAllById returns Iterable; use StreamSupport.stream(iter.spliterator(), false) to convert
- In @Query SQL, quote reserved keywords like `"primary"` for PostgreSQL compatibility

---

## 2026-01-13 23:48 - US-001
Thread: https://ampcode.com/threads/T-019bb98a-656a-7339-8e00-e64b93db4dae
- Implemented `findAllById(Set<CountryId> ids)` in CountryRepositoryDataJdbcAdapter
- Implemented same method in InMemoryCountryRepository for test compatibility
- Returns `Map<CountryId, Country>` for efficient lookup
- Uses existing `countryJdbcRepository.findAllByIdIn(rawIds)` for batch query

**Files changed:**
- backend/src/main/java/de/jobst/resulter/adapter/driven/jdbc/CountryRepositoryDataJdbcAdapter.java
- backend/src/main/java/de/jobst/resulter/adapter/driven/inmemory/InMemoryCountryRepository.java

**Learnings for future iterations:**
- CountryJdbcRepository already had `findAllByIdIn` method prepared - check existing JdbcRepository methods before adding new ones
- The port interface (CountryRepository) already declared `findAllById` - it just needed implementation
- Always implement both JDBC and InMemory adapters when adding new repository methods
---

## 2026-01-13 23:52 - US-002
Thread: https://ampcode.com/threads/T-019bb98c-27a2-70ab-8d11-e89b6726c967
- Added overloaded `asOrganisation(Map<Long, Organisation>, Map<Long, Country>)` method to OrganisationDbo
- Added `batchLoadCountries()` helper method to OrganisationRepositoryDataJdbcAdapter
- Updated `findAll()` to use batch country loading instead of resolver function
- Fixed InMemoryOrganisationRepository.findAllById() to return proper map instead of null

**Files changed:**
- backend/src/main/java/de/jobst/resulter/adapter/driven/jdbc/OrganisationDbo.java
- backend/src/main/java/de/jobst/resulter/adapter/driven/jdbc/OrganisationRepositoryDataJdbcAdapter.java
- backend/src/main/java/de/jobst/resulter/adapter/driven/inmemory/InMemoryOrganisationRepository.java

**Learnings for future iterations:**
- OrganisationJdbcRepository.findAll() returns Collection, not List
- The resolver functions in asOrganisation() are currently unused since domain stores IDs not full objects
- Added both instance and static versions of asOrganisation with Maps for flexibility
---

## 2026-01-13 23:54 - US-003
Thread: https://ampcode.com/threads/T-019bb990-1f85-723f-8f2a-6c84f28afae8
- **Already completed in US-002** - The overloaded asOrganisation method was implemented ahead of schedule
- Verified: instance method `asOrganisation(Map<Long, Organisation>, Map<Long, Country>)` exists at line 104
- Verified: static method with same maps exists at line 117
- Verified: Original resolver-based methods remain at lines 83-102
- Compile and tests pass

**Files changed:** None (already done)

**Learnings for future iterations:**
- When implementing batch-loading patterns, the Map-accepting methods are often added together with the batch-loading logic
- Check if stories are already satisfied by previous work before implementing
---

## 2026-01-13 23:56 - US-004
Thread: https://ampcode.com/threads/T-019bb991-5fe8-77aa-9634-9e390ab1e278
- Updated `findAll(filter, pageable)` to use batch country loading instead of getCountryResolver()
- Updated `findAllById()` to use batch country loading
- Updated `findByIds()` to use batch country loading
- Now all findAll variants use the `batchLoadCountries()` helper for efficient Country loading

**Files changed:**
- backend/src/main/java/de/jobst/resulter/adapter/driven/jdbc/OrganisationRepositoryDataJdbcAdapter.java

**Learnings for future iterations:**
- The pattern is: collect DBOs, batch-load Countries with `batchLoadCountries()`, then use `asOrganisation(Collections.emptyMap(), countryMap)`
- Empty orgMap is fine because Organisation domain stores CountryId, not full Country objects
---

## 2026-01-13 23:58 - US-005
Thread: https://ampcode.com/threads/T-019bb993-086a-779b-a3a8-af9524cbe393
- Added Map-accepting overloads to EventDbo for batch Organisation loading
- Added `asEvents(Collection<EventDbo>, Map<Long, Organisation>)` static method
- Added `asEvent(EventDbo, Map<Long, Organisation>)` static method
- Added `asEvent(Map<Long, Organisation>)` instance method
- Original resolver-based methods remain unchanged

**Files changed:**
- backend/src/main/java/de/jobst/resulter/adapter/driven/jdbc/EventDbo.java

**Learnings for future iterations:**
- EventDbo follows same Map-accepting pattern as OrganisationDbo
- Event stores OrganisationIds (not full Organisation objects), so the Map parameter is for consistency but not strictly required for resolution
- The conversion logic is identical between resolver-based and Map-based methods - just different method signatures
---

## 2026-01-14 00:00 - US-006
Thread: https://ampcode.com/threads/T-019bb994-a974-74f8-8214-5775d4690737
- Added `batchLoadOrganisations(Collection<EventDbo>)` helper method to EventRepositoryDataJdbcAdapter
- Updated `findAll()` to use batch Organisation loading via the new helper
- Updated `findAllById()` to use batch Organisation loading
- Both methods now collect org IDs and batch-load with single query instead of N+1

**Files changed:**
- backend/src/main/java/de/jobst/resulter/adapter/driven/jdbc/EventRepositoryDataJdbcAdapter.java

**Learnings for future iterations:**
- EventOrganisationDbo.id is package-private, access it directly as `eo.id.getId()` (not via getter)
- OrganisationJdbcRepository.findAllById returns Iterable, use StreamSupport.stream() to convert to stream
- The batchLoadOrganisations pattern: collect IDs -> findAllById -> collect to Map<Long, Organisation>
---

## 2026-01-14 00:03 - US-007
Thread: https://ampcode.com/threads/T-019bb997-7daf-73ec-b7d5-8d329210c649
- Optimized `findAll(filter, pageable)` to use batch-loading for both Organisations and EventCertificates
- Added `findPrimaryByEventIdIn(Set<Long> eventIds)` to EventCertificateJdbcRepository with @Query annotation
- Added `batchLoadPrimaryEventCertificates(Collection<EventDbo>)` helper method to EventRepositoryDataJdbcAdapter
- Now uses Map-based batch loading instead of N+1 resolver functions

**Files changed:**
- backend/src/main/java/de/jobst/resulter/adapter/driven/jdbc/EventCertificateJdbcRepository.java
- backend/src/main/java/de/jobst/resulter/adapter/driven/jdbc/EventRepositoryDataJdbcAdapter.java

**Learnings for future iterations:**
- PostgreSQL requires quoting `"primary"` in SQL because it's a reserved keyword
- Event.setCertificate(EventCertificateId) is the direct setter; use instead of withCertificate(Function) for batch loading
- EventCertificateDbo.getEvent() returns AggregateReference, call .getId() to get the Long value
---

